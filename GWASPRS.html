<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.376">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Zohreh Morshedizad">
<meta name="dcterms.date" content="2024-01-15">

<title>Genome-Wide Association Study (GWAS) and Polygenic Risk Score (PRS)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="GWASPRS_files/libs/clipboard/clipboard.min.js"></script>
<script src="GWASPRS_files/libs/quarto-html/quarto.js"></script>
<script src="GWASPRS_files/libs/quarto-html/popper.min.js"></script>
<script src="GWASPRS_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="GWASPRS_files/libs/quarto-html/anchor.min.js"></script>
<link href="GWASPRS_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="GWASPRS_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="GWASPRS_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="GWASPRS_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="GWASPRS_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(images/banner.jpg);
background-size: cover;
      }
</style>


</head>

<body class="fullcontent">

<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Genome-Wide Association Study (GWAS) and Polygenic Risk Score (PRS)</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Zohreh Morshedizad </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 15, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Introduction</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Traits</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Search a Trait.</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">Search an ID</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false" href="">Calculate PRS</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>Welcome to the Genome-Wide Association Study (GWAS) and Polygenic Risk Score (PRS) Shiny App!</p>
<p>This interactive tool, developed by Zohreh Morshedizad from University of Florida, allows you to explore genetic data and perform analyses related to GWAS and PRS. Whether you’re a researcher, student, or anyone interested in genetics, this app provides you with the capabilities to discover associations between traits and genetic variants and calculate Polygenic Risk Scores.</p>
<p><strong>Getting Started:</strong> - In the “Traits” section, you can download the available traits from the database. Click the “Download the traits” button to get started. - Use the search feature to find specific traits by entering keywords in the “Submit a Trait” field and clicking the “Search” button. - In the “Search an ID” section, enter an ID to search for associations related to that specific trait. Visualize the associations using Volcano and Manhattan plots.</p>
<p><strong>Calculating Polygenic Risk Scores:</strong> - The “Calculate PRS” section allows you to compute Polygenic Risk Scores based on selected genetic variants. Adjust the P-value threshold, enter genotype data, and click “Calculate PRS” to generate the scores. - The PRS are categorized into “Positive Effects” and “Negative Effects,” displaying the associated variants for each category. - You can also view the selected variants’ effects on your genotype data and see the calculated PRS and normalized PRS.</p>
<p>Feel free to explore and utilize the functionalities of this app to gain insights into genetic associations and polygenic risk scores. If you have any questions or need assistance, don’t hesitate to reach out for help.</p>
<p>Start your genetic exploration now!</p>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>At the first step, We should get the traits from our database. It will take a while.</p>
<div class="cell">
<div class="cell-output-display">
<br>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<style>.shinybusy-nanobar .bar {background: #43c3a7; height: 8px;}</style>
<script type="application/json" data-for="shinybusy">{"timeout":1000,"mode":"nanobar","classname":"shinybusy-nanobar","type":"auto"}</script>
</div>
<div class="cell-output-display">
<button id="getTraits" type="button" class="btn btn-default action-button">Download the traits</button>
</div>
<div class="cell-output-display">
<div id="gtable" class="shiny-html-output"></div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<br>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="searchaTrait-label" for="searchaTrait">Submit a Trait</label>
<input id="searchaTrait" type="text" class="shiny-input-text form-control" value="">
</div>
</div>
<div class="cell-output-display">
<br>
</div>
<div class="cell-output-display">
<button id="getsearchTraits" type="button" class="btn btn-default action-button">Search</button>
</div>
<div class="cell-output-display">
<br>
</div>
<div class="cell-output-display">
<div id="gtableTrait" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<br>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="insertID-label" for="insertID">Insert an ID</label>
<input id="insertID" type="text" class="shiny-input-text form-control" value="">
</div>
</div>
<div class="cell-output-display">
<br>
</div>
<div class="cell-output-display">
<button id="getID" type="button" class="btn btn-default action-button">Search</button>
</div>
<div class="cell-output-display">
<br>
</div>
<div class="cell-output-display">
<div id="gIDdata" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<br>
</div>
<div class="cell-output-display">
<div class="shiny-plot-output html-fill-item" id="volcano" style="width:100%;height:400px;"></div>
</div>
<div class="cell-output-display">
<br>
</div>
<div class="cell-output-display">
<div class="shiny-plot-output html-fill-item" id="manhattan" style="width:100%;height:400px;"></div>
</div>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<section id="prs" class="level3">
<h3 class="anchored">PRS</h3>
<div class="cell">
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="pval-label" for="pval">P-Value Threshold</label>
<input id="pval" type="number" class="shiny-input-number form-control" value="0.005" min="0" max="1">
</div>
</div>
<div class="cell-output-display">
<br>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="genotype_input-label" for="genotype_input">Enter Genotype Data:</label>
<input id="genotype_input" type="text" class="shiny-input-text form-control" value="">
</div>
</div>
<div class="cell-output-display">
<br>
</div>
<div class="cell-output-display">
<button id="calculate_prs" type="button" class="btn btn-default action-button">Calculate PRS</button>
</div>
<div class="cell-output-display">
<h2 class="anchored" data-anchor-id="prs">Positive Effects</h2>
</div>
<div class="cell-output-display">
<div id="prs_positive" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<h2 class="anchored">Negative Effects</h2>
</div>
<div class="cell-output-display">
<div id="prs_negative" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<h2 class="anchored">The Case</h2>
</div>
<div class="cell-output-display">
<div id="mygenspositive" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<div id="mygensnegative" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<h2 class="anchored">Calculated PRS of the Case</h2>
</div>
<div class="cell-output-display">
<div id="myprs" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<div id="min_prs" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<div id="max_prs" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<div id="normprs" class="shiny-html-output"></div>
</div>
</div>
</section>
</div>
</div>
</div>
<p>
<script type="application/shiny-prerendered" data-context="server-start">
library(shiny)
library(gwasrapidd)
library(dplyr)
library(tidyr)
library(gt)
library(shinycssloaders)
library(shinybusy)
library(shinyWidgets)
library(magrittr)
library(ggplot2)
library(openai)
library(gptchatteR)
library(purrr)
library(easyPubMed)
</script>
 
<script type="application/shiny-prerendered" data-context="server">
 my_traits <- eventReactive(input$getTraits, {

   gwasrapidd::get_traits()
   
  })

  
  output$gtable <- renderTable({
    gt::gt(my_traits()@traits)
  })

</script>
 
<script type="application/shiny-prerendered" data-context="server">
the_trait <- eventReactive(input$getsearchTraits, {
   dplyr::filter(my_traits()@traits, grepl(input$searchaTrait, trait, ignore.case = TRUE))
  })
  output$gtableTrait <- renderTable({
    gt::gt(the_trait())
  })

</script>
 
<script type="application/shiny-prerendered" data-context="server">
my_association <- eventReactive(input$getID, {
  gwasrapidd::get_associations(efo_id = input$insertID)
  })
tbl01 <- reactive(dplyr::select(my_association()@risk_alleles, association_id, variant_id, risk_allele)) 

tbl02 <- reactive(dplyr::select(my_association()@associations, association_id, pvalue, beta_number, beta_unit, beta_direction))
library(magrittr)
my_variants <- reactive(dplyr::left_join(tbl01(), tbl02(), by = 'association_id') %>%
  tidyr::drop_na() %>%
  dplyr::arrange(variant_id, risk_allele))


output$gIDdata <- renderTable({
    gt::gt(my_variants())
  })

library(ggplot2)  

output$volcano <- renderPlot({
  ggplot2::ggplot(my_variants(), aes(x = beta_number, y = -log10(pvalue), color = beta_direction)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  labs(x = "Effect Size (Beta)", y = "-log10(p-value)", title = "Volcano Plot")
})


output$manhattan <- renderPlot({
  ggplot2::ggplot(my_variants(), aes(x = variant_id, y = -log10(pvalue), color = beta_direction)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  facet_wrap(~ risk_allele, scales = "free_x") +
  labs(x = "Variant", y = "-log10(p-value)", title = "Manhattan Plot")
  })
</script>
 
<script type="application/shiny-prerendered" data-context="server">
library(purrr)  # Load purrr for functional programming

prs_data <- eventReactive(input$calculate_prs, {
  filter(my_variants(), pvalue < input$pval)
})

prs_data_positive <- reactive({
  filter(prs_data(),beta_direction == "increase" )
})

prs_data_negative <- reactive({
  filter(prs_data(),beta_direction == "decrease" )
})

output$prs_positive <- renderTable({
    gt::gt(prs_data_positive())
  })

output$prs_negative <- renderTable({
    gt::gt(prs_data_negative())
  })  

minprs <- reactive({
min(0, -sum(prs_data_negative()$beta_number))
}) 

maxprs <- reactive({
max(0, sum(prs_data_positive()$beta_number))
}) 



mygenpositive <- reactive({
  filter(prs_data_positive(),  variant_id %in% c(strsplit(input$genotype_input, " ")[[1]]) )
})

mygennegative <- reactive({
  filter(prs_data_negative(),  variant_id %in% c(strsplit(input$genotype_input, " ")[[1]]) )
})




output$mygenspositive <- renderTable({
 gt::gt(mygenpositive())
  }) 

output$mygensnegative <- renderTable({
 gt::gt(mygennegative())
  }) 


my_prs <- reactive({
min(0, -sum(mygennegative()$beta_number)) + max(0, sum(mygenpositive()$beta_number))
}) 


 
output$myprs <- renderTable({
c(paste("PRS = ",my_prs()),paste("Maximum = ",maxprs()),
 paste("Minimum = ",minprs()),
 paste("Normalized PRS: ",0,"<",(my_prs()-minprs())/(maxprs()-minprs()),"<",1 ))

 
})
  

</script>
 
<script type="application/shiny-prerendered" data-context="server-extras">
ojs_define <- function(..., .session = shiny::getDefaultReactiveDomain()) {
  quos <- rlang::enquos(...)
  vars <- rlang::list2(...)
  nm <- names(vars)
  if (is.null(nm)) {
    nm <- rep_len("", length(vars))
  }
  mapply(function(q, nm, val) {
    # Infer name, if possible
    if (nm == "") {
      tryCatch({
        nm <- rlang::as_name(q)
      }, error = function(e) {
        code <- paste(collapse = "\n", deparse(rlang::f_rhs(q)))
        stop("ojs_define() could not create a name for the argument: ", code)
      })
    }
    .session$output[[nm]] <- val
    outputOptions(.session$output, nm, suspendWhenHidden = FALSE)
    .session$sendCustomMessage("ojs-export", list(name = nm))
    NULL
  }, quos, nm, vars, SIMPLIFY = FALSE, USE.NAMES = FALSE)
  invisible()
}
</script>
</p>
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["shinybusy-busy"]},{"type":"character","attributes":{},"value":["0.3.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["packer"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["busy.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shinybusy"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.3.1"]}]}]}
</script>
<!--/html_preserve-->
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="execution_dependencies">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages","version"]},"class":{"type":"character","attributes":{},"value":["data.frame"]},"row.names":{"type":"integer","attributes":{},"value":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65]}},"value":[{"type":"character","attributes":{},"value":["base","bslib","cachem","cli","colorspace","compiler","datasets","digest","dplyr","easyPubMed","ellipsis","evaluate","fansi","fastmap","generics","ggplot2","glue","gptchatteR","graphics","grDevices","grid","gt","gtable","gwasrapidd","htmltools","htmlwidgets","httpuv","jquerylib","jsonlite","knitr","later","lifecycle","magrittr","methods","mime","munsell","openai","pillar","pkgconfig","promises","purrr","R6","Rcpp","rlang","rmarkdown","rstudioapi","sass","scales","shiny","shinybusy","shinycssloaders","shinyWidgets","stats","tibble","tidyr","tidyselect","tools","utf8","utils","vctrs","withr","xfun","xml2","xtable","yaml"]},{"type":"character","attributes":{},"value":["4.3.1","0.5.1","1.0.8","3.6.1","2.1-0","4.3.1","4.3.1","0.6.33","1.1.2","2.13","0.3.2","0.21","1.0.4","1.1.1","0.1.3","3.4.3","1.6.2","0.1.0","4.3.1","4.3.1","4.3.1","0.9.0","0.3.3","0.99.14","0.5.6","1.6.2","1.6.11","0.1.4","1.8.7","1.43","1.3.1","1.0.3","2.0.3","4.3.1","0.12","0.5.0","0.4.1","1.9.0","2.0.3","1.2.1","1.0.2","2.5.1","1.0.11","1.1.1","2.24","0.15.0","0.4.7","1.2.1","1.7.5","0.3.1","1.0.0","0.7.6","4.3.1","3.2.1","1.3.0","1.2.0","4.3.1","1.2.3","4.3.1","0.6.3","2.5.0","0.40","1.3.5","1.8-4","2.3.7"]}]}]}
</script>
<!--/html_preserve-->

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        console.log("RESIZE");
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>